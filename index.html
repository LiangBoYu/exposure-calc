<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>曝光計算器 (EV/ISO/快門/光圈/ND)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Fraunces:wght@600;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0e1b26;
      --bg2: #1b2a3b;
      --ink: #f4f2ed;
      --muted: #b7c4cf;
      --accent: #f1a208;
      --accent2: #58d6c8;
      --card: rgba(255, 255, 255, 0.08);
      --stroke: rgba(255, 255, 255, 0.18);
      --shadow: 0 20px 50px rgba(0, 0, 0, 0.35);
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      color: var(--ink);
      font-family: "Space Grotesk", ui-sans-serif, system-ui, sans-serif;
      background:
        radial-gradient(900px 400px at 10% 0%, rgba(88, 214, 200, 0.25), transparent 60%),
        radial-gradient(700px 500px at 90% 10%, rgba(241, 162, 8, 0.18), transparent 55%),
        linear-gradient(160deg, var(--bg), var(--bg2));
      min-height: 100svh;
    }

    header {
      padding: 12px 16px 4px;
      text-align: center;
      animation: fadeIn 700ms ease-out both;
    }

    h1 {
      font-family: "Fraunces", "Times New Roman", serif;
      font-size: clamp(18px, 4vw, 28px);
      margin: 0 0 4px;
      letter-spacing: 0.3px;
    }

    header p {
      margin: 0;
      color: var(--muted);
      font-size: 11px;
    }

    main {
      display: grid;
      gap: 8px;
      padding: 8px 10px 18px;
      width: min(94vw, 720px);
      max-width: 720px;
      margin: 0 auto;
      animation: riseIn 800ms ease-out both 120ms;
    }

    .card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .card.active-mode {
      border-color: rgba(88, 214, 200, 0.8);
      box-shadow: 0 12px 30px rgba(88, 214, 200, 0.25);
    }

    .card.active-mode .section-title {
      color: #7be7da;
    }

    .card.active-mode .section-title .pill {
      background: rgba(123, 231, 218, 0.28);
      color: #0c1b24;
    }

    .compact-card {
      padding: 10px;
    }

    .section-title {
      font-weight: 600;
      letter-spacing: 0.2px;
      margin: 0 0 6px;
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .pill {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(88, 214, 200, 0.2);
      color: var(--accent2);
    }

    .mode-toggle {
      margin-left: auto;
      font-size: 11px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.08);
      color: var(--muted);
      border: 1px solid rgba(255, 255, 255, 0.15);
      cursor: pointer;
    }

    .mode-toggle.active {
      background: rgba(88, 214, 200, 0.2);
      color: var(--accent2);
      border-color: rgba(88, 214, 200, 0.5);
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .grid.two {
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    }

    .grid.row {
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 6px;
    }

    label {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .label-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }

    .label-row label {
      margin-bottom: 0;
    }

    input, select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: rgba(255, 255, 255, 0.12);
      color: var(--ink);
      font-size: 13px;
      outline: none;
      transition: border 150ms ease, box-shadow 150ms ease;
    }

    input:focus, select:focus {
      border-color: var(--accent2);
      box-shadow: 0 0 0 2px rgba(88, 214, 200, 0.18);
    }

    select:disabled {
      opacity: 0.55;
      cursor: not-allowed;
    }

    select option {
      color: #0f1720;
      background: #f4f2ed;
    }

    input[disabled] {
      opacity: 0.65;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      font-weight: 600;
      cursor: pointer;
      background: var(--accent);
      color: #1a1202;
      transition: transform 120ms ease, filter 120ms ease;
    }

    button:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .lock-toggle {
      background: rgba(88, 214, 200, 0.2);
      color: var(--accent2);
      font-size: 12px;
      padding: 4px 10px;
    }

    .solve-active {
      border-radius: 12px;
      outline: 1px solid rgba(111, 168, 255, 0.7);
      box-shadow: 0 0 0 2px rgba(111, 168, 255, 0.25);
      background: rgba(111, 168, 255, 0.08);
    }

    .solve-active .wheel {
      border-color: rgba(111, 168, 255, 0.7);
      background: rgba(111, 168, 255, 0.18);
    }

    .solve-active .wheel-item.is-selected {
      color: #b7d4ff;
    }

    .field-highlight .wheel {
      border-color: rgba(241, 162, 8, 0.7);
      background: rgba(241, 162, 8, 0.18);
    }

    .field-highlight .wheel-item.is-selected {
      color: #ffd17a;
    }

    .base-field .wheel {
      border-color: rgba(124, 215, 155, 0.5);
      background: rgba(124, 215, 155, 0.12);
    }

    .base-field .wheel-item.is-selected {
      color: #b8f0cf;
    }

    .wheel-select {
      display: none;
    }

    .wheel {
      height: 128px;
      overflow-y: auto;
      scroll-snap-type: y mandatory;
      padding: 26px 0;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.12);
      border: 1px solid transparent;
      position: relative;
    }

    .wheel.collapsed {
      height: 36px;
      padding: 0;
      overflow: hidden;
    }

    .wheel.collapsed::before,
    .wheel.collapsed::after {
      height: 0;
    }

    .wheel::-webkit-scrollbar {
      width: 0;
      height: 0;
    }

    .wheel::before,
    .wheel::after {
      content: "";
      display: block;
      height: calc(50% - 16px);
    }

    .wheel-item {
      scroll-snap-align: center;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 12px;
      text-align: center;
      color: var(--muted);
      font-size: 14px;
    }

    .wheel-item.is-selected {
      color: var(--ink);
      font-weight: 600;
    }

    .wheel.disabled {
      opacity: 0.5;
      pointer-events: none;
    }

    .countdown {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      font-size: 13px;
      color: var(--muted);
    }

    .countdown strong {
      color: var(--ink);
      font-size: 14px;
    }

    .stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
    }

    .stat {
      padding: 10px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.08);
      border: 1px solid rgba(255, 255, 255, 0.12);
    }

    .stat span {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    .stat strong {
      font-size: 17px;
      letter-spacing: 0.2px;
    }

    .stats-card .stat {
      padding: 10px 12px;
      text-align: center;
    }

    .stats-card .stat strong {
      font-size: clamp(20px, 6vw, 28px);
    }

    .stats-card .stat span {
      font-size: 12px;
    }

    .countdown-card {
      text-align: center;
      padding: 14px 12px 16px;
    }

    .countdown-card .time {
      font-size: clamp(20px, 6.5vw, 36px);
      font-weight: 600;
      letter-spacing: 0.4px;
      margin: 4px 0 8px;
    }

    .countdown-card .time span {
      font-size: 14px;
      color: var(--muted);
      margin-left: 6px;
    }

    .countdown-actions {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      margin-top: 8px;
      color: var(--muted);
      font-size: 12px;
    }

    #countdown-display {
      font-size: clamp(18px, 6vw, 26px);
      color: var(--ink);
    }

    #countdown-display.alert {
      color: #ff6b6b;
    }

    .note {
      color: var(--muted);
      font-size: 11px;
      line-height: 1.5;
      margin-top: 10px;
    }

    .formula {
      font-size: 11px;
      color: var(--muted);
      line-height: 1.6;
    }

    .formula strong {
      color: var(--ink);
      font-weight: 600;
    }

    .result {
      font-size: 15px;
      color: var(--accent);
      margin-top: 6px;
    }

    .warning {
      color: #ffb347;
      font-size: 12px;
      margin-top: 6px;
    }

    footer {
      text-align: center;
      padding: 0 16px 24px;
      color: var(--muted);
      font-size: 12px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes riseIn {
      from { opacity: 0; transform: translateY(12px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header>
    <h1>曝光計算器</h1>
    <p>EV / ISO 光圈 / 快門 / ND 濾鏡 — 專為長曝與手機使用設計<br />支援手機瀏覽。數值僅供參考，實拍時請依環境調整。</p>
  </header>

  <main>
    <section class="card stats-card compact-card">
      <div class="stats">
        <div class="stat">
          <span>EV (含 ND)</span>
          <strong id="scene-ev">--</strong>
        </div>
      </div>
    </section>

    <section class="card compact-card">
      <div class="section-title">基準參數 <span class="pill">Base</span></div>
      <div class="grid row">
        <div class="base-field">
          <label for="base-iso">ISO</label>
          <select id="base-iso" class="wheel-select"></select>
          <div class="wheel" data-wheel="base-iso"></div>
        </div>
        <div class="base-field">
          <label for="base-aperture">光圈 (f)</label>
          <select id="base-aperture" class="wheel-select"></select>
          <div class="wheel" data-wheel="base-aperture"></div>
        </div>
        <div class="base-field">
          <label for="base-shutter">快門</label>
          <select id="base-shutter" class="wheel-select"></select>
          <div class="wheel" data-wheel="base-shutter"></div>
        </div>
        <div class="base-field">
          <label for="base-nd">ND 濾鏡 (檔)</label>
          <select id="base-nd" class="wheel-select"></select>
          <div class="wheel" data-wheel="base-nd"></div>
        </div>
      </div>
      <div class="note">提示：基準值是你目前的設定。若要加入 ND 濾鏡，請在下面「目標」區塊輸入 ND 檔數。</div>
      <div class="note formula">
        <strong>計算公式</strong><br />
        EV100 = log2(N² / t) - log2(ISO / 100)<br />
        場景 EV100 = EV100 + ND(檔)<br />
        有效 EV100 = 場景 EV100 - ND(檔)<br />
        t = N² / 2^(有效 EV100 + log2(ISO / 100))
      </div>
    </section>

    <section class="card compact-card" id="target-section">
      <div class="section-title">
        目標參數 <span class="pill">Target</span>
        <button class="mode-toggle" type="button" data-mode="target">使用倒數</button>
      </div>
      <div class="grid row">
        <div class="target-field" data-target-field="target-iso">
          <div class="label-row">
            <label for="target-iso">ISO</label>
            <button class="lock-toggle" type="button" data-lock="target-iso">解鎖</button>
          </div>
          <select id="target-iso" class="wheel-select"></select>
          <div class="wheel" data-wheel="target-iso"></div>
        </div>
        <div class="target-field" data-target-field="target-aperture">
          <div class="label-row">
            <label for="target-aperture">光圈 (f)</label>
            <button class="lock-toggle" type="button" data-lock="target-aperture">解鎖</button>
          </div>
          <select id="target-aperture" class="wheel-select"></select>
          <div class="wheel" data-wheel="target-aperture"></div>
        </div>
        <div class="target-field" data-target-field="target-nd">
          <div class="label-row">
            <label for="target-nd">ND 濾鏡 (檔)</label>
            <button class="lock-toggle" type="button" data-lock="target-nd">解鎖</button>
          </div>
          <select id="target-nd" class="wheel-select"></select>
          <div class="wheel" data-wheel="target-nd"></div>
        </div>
      </div>
      <div class="note" id="result-note">依據上方基準 EV 計算，ISO 或光圈其一維持基準設定。</div>
    </section>

    <section class="card compact-card" id="solve-section">
      <div class="section-title">
        求參數 <span class="pill">Solve</span>
        <button class="mode-toggle" type="button" data-mode="solve">使用倒數</button>
      </div>
      <div class="grid row">
        <div>
          <label for="solve-param">想改的參數</label>
          <select id="solve-param">
            <option value="shutter">快門</option>
            <option value="aperture">光圈</option>
            <option value="iso">ISO</option>
            <option value="nd">ND</option>
          </select>
        </div>
        <div class="solve-field" data-solve-field="solve-iso">
          <div class="label-row">
            <label for="solve-iso">ISO</label>
            <button class="lock-toggle" type="button" data-solve-lock="solve-iso">解鎖</button>
          </div>
          <select id="solve-iso" class="wheel-select"></select>
          <div class="wheel" data-wheel="solve-iso"></div>
        </div>
        <div class="solve-field" data-solve-field="solve-aperture">
          <div class="label-row">
            <label for="solve-aperture">光圈 (f)</label>
            <button class="lock-toggle" type="button" data-solve-lock="solve-aperture">解鎖</button>
          </div>
          <select id="solve-aperture" class="wheel-select"></select>
          <div class="wheel" data-wheel="solve-aperture"></div>
        </div>
        <div class="solve-field" data-solve-field="solve-shutter">
          <div class="label-row">
            <label for="solve-shutter">快門</label>
            <button class="lock-toggle" type="button" data-solve-lock="solve-shutter">解鎖</button>
          </div>
          <select id="solve-shutter" class="wheel-select"></select>
          <div class="wheel" data-wheel="solve-shutter"></div>
        </div>
        <div class="solve-field" data-solve-field="solve-nd">
          <div class="label-row">
            <label for="solve-nd">ND 濾鏡 (檔)</label>
            <button class="lock-toggle" type="button" data-solve-lock="solve-nd">解鎖</button>
          </div>
          <select id="solve-nd" class="wheel-select"></select>
          <div class="wheel" data-wheel="solve-nd"></div>
        </div>
      </div>
      <div class="note" id="solve-desc">固定 ISO / 光圈 / ND 兩項後，系統會告訴你該改哪個參數。</div>
      <div class="result" id="solve-result">--</div>
      <div class="warning" id="solve-warning"></div>
    </section>

    <section class="card countdown-card compact-card">
      <div class="section-title">拍照倒數 <span class="pill">Timer</span></div>
      <div class="time"><strong id="base-time">--</strong><span>sec</span></div>
      <div class="countdown-actions">
        <button id="countdown-btn" type="button">開始倒數</button>
        <span>剩餘</span>
        <strong id="countdown-display">--</strong>
      </div>
    </section>
  </main>

  <footer>Designed by Liang Bo-Yu</footer>

  <script>
    const baseAperture = document.getElementById("base-aperture");
    const baseShutter = document.getElementById("base-shutter");
    const baseIso = document.getElementById("base-iso");
    const baseNd = document.getElementById("base-nd");

    const targetAperture = document.getElementById("target-aperture");
    const targetIso = document.getElementById("target-iso");
    const targetNd = document.getElementById("target-nd");
    const lockButtons = document.querySelectorAll("[data-lock]");

    const sceneEvEl = document.getElementById("scene-ev");
    const baseTimeEl = document.getElementById("base-time");
    const countdownBtn = document.getElementById("countdown-btn");
    const countdownDisplay = document.getElementById("countdown-display");
    const resultNoteEl = document.getElementById("result-note");
    const solveParam = document.getElementById("solve-param");
    const solveShutter = document.getElementById("solve-shutter");
    const solveAperture = document.getElementById("solve-aperture");
    const solveIso = document.getElementById("solve-iso");
    const solveNd = document.getElementById("solve-nd");
    const solveDesc = document.getElementById("solve-desc");
    const solveResult = document.getElementById("solve-result");
    const solveWarning = document.getElementById("solve-warning");
    const solveLockButtons = document.querySelectorAll("[data-solve-lock]");
    const solveFields = document.querySelectorAll("[data-solve-field]");
    const targetFields = document.querySelectorAll("[data-target-field]");
    const targetSection = document.getElementById("target-section");
    const solveSection = document.getElementById("solve-section");
    const modeToggles = document.querySelectorAll("[data-mode]");

    const wheelMap = new Map();
    let countdownMode = "base";
    let solveSuggestedShutter = NaN;

    const commonDenominators = [
      1, 2, 3, 4, 5, 6, 8, 10, 13, 15, 20, 25, 30, 40, 50, 60, 80, 100, 125, 160, 200,
      250, 320, 400, 500, 640, 800, 1000, 1250, 1600, 2000, 2500, 3200, 4000, 5000, 6400, 8000
    ];
    const apertureOptions = [1.0, 1.4, 2, 2.8, 4, 5.6, 8, 11, 16, 22, 32];
    const isoOptions = [50, 100, 200, 400, 800, 1600, 3200, 6400, 12800, 25600, 51200, 102400];
    const ndOptions = [0, 0.3, 0.6, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    const shutterOptions = [
      { label: "30s", value: 30 },
      { label: "25s", value: 25 },
      { label: "20s", value: 20 },
      { label: "15s", value: 15 },
      { label: "13s", value: 13 },
      { label: "10s", value: 10 },
      { label: "8s", value: 8 },
      { label: "6s", value: 6 },
      { label: "5s", value: 5 },
      { label: "4s", value: 4 },
      { label: "3.2s", value: 3.2 },
      { label: "2.5s", value: 2.5 },
      { label: "2s", value: 2 },
      { label: "1.6s", value: 1.6 },
      { label: "1.3s", value: 1.3 },
      { label: "1s", value: 1 },
      { label: "1/1.3", value: 1 / 1.3 },
      { label: "1/1.6", value: 1 / 1.6 },
      { label: "1/2", value: 0.5 },
      { label: "1/2.5", value: 1 / 2.5 },
      { label: "1/3.2", value: 1 / 3.2 },
      { label: "1/4", value: 1 / 4 },
      { label: "1/5", value: 1 / 5 },
      { label: "1/6", value: 1 / 6 },
      { label: "1/8", value: 1 / 8 },
      { label: "1/10", value: 1 / 10 },
      { label: "1/13", value: 1 / 13 },
      { label: "1/15", value: 1 / 15 },
      { label: "1/20", value: 1 / 20 },
      { label: "1/25", value: 1 / 25 },
      { label: "1/30", value: 1 / 30 },
      { label: "1/40", value: 1 / 40 },
      { label: "1/50", value: 1 / 50 },
      { label: "1/60", value: 1 / 60 },
      { label: "1/80", value: 1 / 80 },
      { label: "1/100", value: 1 / 100 },
      { label: "1/125", value: 1 / 125 },
      { label: "1/160", value: 1 / 160 },
      { label: "1/200", value: 1 / 200 },
      { label: "1/250", value: 1 / 250 },
      { label: "1/320", value: 1 / 320 },
      { label: "1/400", value: 1 / 400 },
      { label: "1/500", value: 1 / 500 },
      { label: "1/640", value: 1 / 640 },
      { label: "1/800", value: 1 / 800 },
      { label: "1/1000", value: 1 / 1000 },
      { label: "1/1250", value: 1 / 1250 },
      { label: "1/1600", value: 1 / 1600 },
      { label: "1/2000", value: 1 / 2000 },
      { label: "1/2500", value: 1 / 2500 },
      { label: "1/3200", value: 1 / 3200 },
      { label: "1/4000", value: 1 / 4000 },
      { label: "1/5000", value: 1 / 5000 },
      { label: "1/6400", value: 1 / 6400 },
      { label: "1/8000", value: 1 / 8000 }
    ];

    function parseShutter(value) {
      const num = Number(value);
      return num > 0 ? num : NaN;
    }

    function formatShutter(seconds) {
      if (!isFinite(seconds) || seconds <= 0) return "--";
      if (seconds >= 60) {
        const minutes = seconds / 60;
        if (minutes >= 60) {
          const hours = minutes / 60;
          return `${hours.toFixed(2)} 小時 (${seconds.toFixed(1)}s)`;
        }
        return `${minutes.toFixed(2)} 分鐘 (${seconds.toFixed(1)}s)`;
      }
      if (seconds >= 1) return `${seconds.toFixed(2)}s`;
      let best = commonDenominators[0];
      let bestErr = Math.abs(seconds - 1 / best);
      for (const denom of commonDenominators) {
        const err = Math.abs(seconds - 1 / denom);
        if (err < bestErr) {
          best = denom;
          bestErr = err;
        }
      }
      return `1/${best} s (${seconds.toFixed(4)}s)`;
    }

    function log2(x) {
      return Math.log(x) / Math.log(2);
    }

    function populateOptions() {
      function addOptions(select, options, formatter) {
        select.innerHTML = "";
        options.forEach((option) => {
          const opt = document.createElement("option");
          if (typeof option === "object") {
            opt.value = String(option.value);
            opt.textContent = option.label;
          } else {
            opt.value = String(option);
            opt.textContent = formatter ? formatter(option) : String(option);
          }
          select.appendChild(opt);
        });
      }

      addOptions(baseAperture, apertureOptions, (value) => `f/${value}`);
      addOptions(targetAperture, apertureOptions, (value) => `f/${value}`);
      addOptions(baseIso, isoOptions);
      addOptions(targetIso, isoOptions);
      addOptions(baseNd, ndOptions, (value) => {
        if (value === 0) return "0 (無)";
        if (Number.isInteger(value)) return `${value} 檔 (ND${Math.pow(2, value)})`;
        return `${value} 檔`;
      });
      addOptions(targetNd, ndOptions, (value) => {
        if (value === 0) return "0 (無)";
        if (Number.isInteger(value)) return `${value} 檔 (ND${Math.pow(2, value)})`;
        return `${value} 檔`;
      });
      addOptions(baseShutter, shutterOptions);
      addOptions(solveShutter, shutterOptions);

      baseAperture.value = "8";
      targetAperture.value = "8";
      baseIso.value = "100";
      targetIso.value = "100";
      baseNd.value = "0";
      targetNd.value = "0";
      baseShutter.value = String(1 / 125);
      solveShutter.value = String(1 / 125);

      addOptions(solveAperture, apertureOptions, (value) => `f/${value}`);
      addOptions(solveIso, isoOptions);
      addOptions(solveNd, ndOptions, (value) => {
        if (value === 0) return "0 (無)";
        if (Number.isInteger(value)) return `${value} 檔 (ND${Math.pow(2, value)})`;
        return `${value} 檔`;
      });
      solveAperture.value = "8";
      solveIso.value = "100";
      solveNd.value = "0";
      initWheel(baseIso);
      initWheel(baseAperture);
      initWheel(baseShutter);
      initWheel(baseNd);
      initWheel(targetIso);
      initWheel(targetAperture);
      initWheel(targetNd);
      initWheel(solveIso);
      initWheel(solveAperture);
      initWheel(solveShutter);
      initWheel(solveNd);
    }

    let countdownTimer = null;
    let countdownEnd = 0;
    let countdownSeconds = NaN;

    function stopCountdown(message) {
      if (countdownTimer) {
        clearInterval(countdownTimer);
        countdownTimer = null;
      }
      countdownBtn.textContent = "開始倒數";
      countdownDisplay.textContent = message || "--";
      countdownDisplay.classList.remove("alert");
    }

    function startCountdown() {
      const seconds = countdownSeconds;
      if (!isFinite(seconds) || seconds <= 0) {
        stopCountdown("--");
        return;
      }
      if (countdownTimer) {
        stopCountdown("--");
        return;
      }
      countdownEnd = Date.now() + seconds * 1000;
      countdownBtn.textContent = "停止";
      countdownTimer = setInterval(() => {
        const remaining = (countdownEnd - Date.now()) / 1000;
        if (remaining <= 0) {
          stopCountdown("完成");
          return;
        }
        countdownDisplay.classList.toggle("alert", remaining <= 10);
        countdownDisplay.textContent = `${remaining.toFixed(1)}s`;
      }, 100);
    }

  function computeSceneEv() {
      const N = Number(baseAperture.value);
      const t = parseShutter(baseShutter.value);
      const iso = Number(baseIso.value);
      const nd = Number(baseNd.value) || 0;

      if (!isFinite(N) || !isFinite(t) || !isFinite(iso) || N <= 0 || t <= 0 || iso <= 0) {
          return { sceneEv: NaN };
      }

      // 計算當前設定下的有效 EV (包含濾鏡影響後的結果)
      const effectiveEv = log2((N * N) / t) - log2(iso / 100);
      
      // 環境真正的亮度 (Scene EV) = 有效 EV + 濾鏡扣掉的檔數
      // 例如：濾鏡扣了 3 檔，相機算出來是 EV 5，那環境其實是 EV 8
      const sceneEv = effectiveEv + nd; 
      return { sceneEv };
  }

  function computeTargetShutter(sceneEv, aperture, iso, targetNd) {
      if (!isFinite(sceneEv) || !isFinite(aperture) || !isFinite(iso)) return NaN;

      // 到達感光元件的有效亮度 = 環境光 - 減光鏡檔數
      const effectiveEv = sceneEv - targetNd;

      // 根據公式 t = N^2 / (2^EV * (ISO/100))
      const shutter = (aperture * aperture) / (Math.pow(2, effectiveEv) * (iso / 100));
      return shutter;
  }

  function computeApertureFromShutter(sceneEv, shutter, iso, targetNd) {
      if (!isFinite(sceneEv) || !isFinite(shutter) || !isFinite(iso)) return NaN;
      const effectiveEv = sceneEv - targetNd;
      return Math.sqrt(shutter * Math.pow(2, effectiveEv) * (iso / 100));
  }

  function computeIsoFromShutter(sceneEv, shutter, aperture, targetNd) {
      if (!isFinite(sceneEv) || !isFinite(shutter) || !isFinite(aperture)) return NaN;
      const effectiveEv = sceneEv - targetNd;
      return 100 * (aperture * aperture) / (shutter * Math.pow(2, effectiveEv));
  }

  function computeNdFromShutter(sceneEv, shutter, aperture, iso) {
      if (!isFinite(sceneEv) || !isFinite(shutter) || !isFinite(aperture) || !isFinite(iso)) return NaN;
      return sceneEv - (log2((aperture * aperture) / shutter) - log2(iso / 100));
  }

  function formatNdLabel(nd) {
      if (!isFinite(nd)) return "--";
      const rounded = Math.round(nd * 10) / 10;
      const isInt = Math.abs(rounded - Math.round(rounded)) < 0.05;
      if (isInt) {
          const stops = Math.round(rounded);
          return `${stops} 檔 (ND${Math.pow(2, stops)})`;
      }
      return `${rounded} 檔`;
  }

  function nearestOption(options, value) {
      let best = options[0];
      let bestErr = Math.abs(value - best);
      options.forEach((option) => {
          const err = Math.abs(value - option);
          if (err < bestErr) {
              best = option;
              bestErr = err;
          }
      });
      return best;
  }

  function nearestShutterValue(value) {
      let best = shutterOptions[0].value;
      let bestErr = Math.abs(value - best);
      shutterOptions.forEach((option) => {
          const err = Math.abs(value - option.value);
          if (err < bestErr) {
              best = option.value;
              bestErr = err;
          }
      });
      return best;
  }

  function initWheel(selectEl) {
      const wheelEl = document.querySelector(`[data-wheel="${selectEl.id}"]`);
      if (!wheelEl) return;
      wheelEl.innerHTML = "";
      const items = [];
      Array.from(selectEl.options).forEach((option) => {
          const item = document.createElement("div");
          item.className = "wheel-item";
          item.dataset.value = option.value;
          item.textContent = option.textContent;
          wheelEl.appendChild(item);
          items.push(item);
      });
      wheelMap.set(selectEl.id, { selectEl, wheelEl, items, isProgrammatic: false });

      wheelEl.classList.add("collapsed");

      wheelEl.addEventListener("click", (event) => {
          if (wheelEl.classList.contains("collapsed")) {
              setWheelExpanded(selectEl, true);
              return;
          }
          const item = event.target.closest(".wheel-item");
          if (!item) return;
          setWheelValue(selectEl, item.dataset.value, true, true);
          setWheelExpanded(selectEl, false);
      });

      let scrollTimer = null;
      wheelEl.addEventListener("scroll", () => {
          const map = wheelMap.get(selectEl.id);
          if (!map || map.isProgrammatic) return;
          clearTimeout(scrollTimer);
          scrollTimer = setTimeout(() => {
              const center = wheelEl.scrollTop + wheelEl.clientHeight / 2;
              let bestItem = items[0];
              let bestErr = Math.abs(center - (bestItem.offsetTop + bestItem.offsetHeight / 2));
              items.forEach((candidate) => {
                  const itemCenter = candidate.offsetTop + candidate.offsetHeight / 2;
                  const err = Math.abs(center - itemCenter);
                  if (err < bestErr) {
                      bestItem = candidate;
                      bestErr = err;
                  }
              });
              setWheelValue(selectEl, bestItem.dataset.value, false, true);
          }, 60);
      });

      setWheelValue(selectEl, selectEl.value, false, false);
  }

  function setWheelExpanded(selectEl, expanded) {
      const map = wheelMap.get(selectEl.id);
      if (!map) return;
      const { wheelEl } = map;
      document.querySelectorAll(".wheel").forEach((wheel) => {
          if (wheel !== wheelEl) {
              wheel.classList.add("collapsed");
          }
      });
      wheelEl.classList.toggle("collapsed", !expanded);
      if (expanded) {
          setWheelValue(selectEl, selectEl.value, true, false);
      }
  }

  function setWheelValue(selectEl, value, scrollIntoView, emitEvent) {
      const map = wheelMap.get(selectEl.id);
      if (!map) return;
      const { wheelEl, items } = map;
      const match = items.find((item) => item.dataset.value === String(value));
      if (!match) return;
      selectEl.value = String(value);
      items.forEach((item) => item.classList.toggle("is-selected", item === match));
      if (scrollIntoView) {
          map.isProgrammatic = true;
          wheelEl.scrollTop = match.offsetTop - (wheelEl.clientHeight - match.offsetHeight) / 2;
          requestAnimationFrame(() => {
              map.isProgrammatic = false;
          });
      }
      if (emitEvent) {
          selectEl.dispatchEvent(new Event("input", { bubbles: true }));
      }
  }

    function syncWheelDisabled(selectEl, disabled) {
      const wheelEl = document.querySelector(`[data-wheel="${selectEl.id}"]`);
      if (wheelEl) {
        wheelEl.classList.toggle("disabled", disabled);
        if (disabled) {
          wheelEl.classList.add("collapsed");
        }
      }
    }

  function isLocked(targetId) {
      const button = document.querySelector(`[data-lock="${targetId}"]`);
      if (!button) return false;
      return button.dataset.locked !== "false";
  }

  function syncSolveLocked(reset = false) {
      const mode = solveParam.value;
      const primaryMap = {
          shutter: "solve-shutter",
          aperture: "solve-aperture",
          iso: "solve-iso",
          nd: "solve-nd"
      };
      const primaryId = primaryMap[mode];

      solveLockButtons.forEach((button) => {
          const targetId = button.dataset.solveLock;
          const target = document.getElementById(targetId);
          if (!target) return;

          const isPrimary = targetId === primaryId;
          if (reset && !isPrimary) {
              button.dataset.locked = "true";
          }

          if (isPrimary) {
              button.dataset.locked = "false";
              button.textContent = "選擇中";
              button.disabled = true;
              target.disabled = false;
              syncWheelDisabled(target, false);
          } else {
              const locked = button.dataset.locked !== "false";
              target.disabled = true;
              button.textContent = locked ? "解鎖" : "求解中";
              button.disabled = false;
              syncWheelDisabled(target, true);
              if (locked) {
                  if (targetId === "solve-iso") target.value = targetIso.value;
                  if (targetId === "solve-aperture") target.value = targetAperture.value;
                  if (targetId === "solve-nd") target.value = targetNd.value;
                  if (targetId === "solve-shutter") target.value = baseShutter.value;
                  setWheelValue(target, target.value, true, false);
              }
          }
      });

      solveFields.forEach((field) => {
          field.classList.toggle("solve-active", field.dataset.solveField === primaryId);
      });
  }

  function render() {
      const { sceneEv } = computeSceneEv();
      const baseSeconds = parseShutter(baseShutter.value);
      const baseValid = isFinite(baseSeconds) && baseSeconds > 0;
      
      // 更新顯示：環境 EV (不含 ND)
      sceneEvEl.textContent = isFinite(sceneEv) ? sceneEv.toFixed(2) : "--";

      const baseIsoVal = Number(baseIso.value);
      const baseApertureVal = Number(baseAperture.value);
      const baseNdVal = Number(baseNd.value) || 0;

      const targetIsoVal = Number(targetIso.value);
      const targetApertureVal = Number(targetAperture.value);
      const targetNdVal = Number(targetNd.value) || 0;

      // 計算目標快門
      const shutterTarget = computeTargetShutter(sceneEv, targetApertureVal, targetIsoVal, targetNdVal);

      if (!isFinite(sceneEv)) {
          resultNoteEl.textContent = "請檢查基準參數是否正確。";
      } else {
          // --- 新增：計算各項參數的檔數變化 ---
          
          // ISO 變化 (1 檔 = 2倍)
          const isoStops = log2(targetIsoVal / baseIsoVal);
          
          // 光圈變化 (1 檔 = 1.414倍，公式為 2 * log2(f_target / f_base))
          // 數值增加（f/8 -> f/11）代表檔數為正，進光減少
          const apertureStops = 2 * log2(targetApertureVal / baseApertureVal);
          
          // ND 變化 (直接相減)
          const ndStops = targetNdVal - baseNdVal;

          // 格式化字串：如果是 0 則顯示 "無變動"，否則顯示 +X 或 -X
          const formatStop = (val, unit) => {
              if (Math.abs(val) < 0.01) return `無變動`;
              return `${val > 0 ? '+' : ''}${val.toFixed(1)} 檔`;
          };

          resultNoteEl.innerHTML = `
              環境亮度鎖定為 <strong>EV ${sceneEv.toFixed(1)}</strong><br/>
              相較基準值：光圈 ${formatStop(apertureStops)}、
              ISO ${formatStop(isoStops)}、
              ND ${formatStop(ndStops)}
          `;
      }
      renderSolve(sceneEv);

      const solveSeconds = isFinite(solveSuggestedShutter)
          ? solveSuggestedShutter
          : parseShutter(solveShutter.value);
      const targetSeconds = shutterTarget;
      const displaySeconds = countdownMode === "solve"
          ? solveSeconds
          : countdownMode === "target"
              ? targetSeconds
              : baseSeconds;
      countdownSeconds = displaySeconds;
      baseTimeEl.textContent = isFinite(displaySeconds) ? formatShutter(displaySeconds) : "--";
      countdownBtn.disabled = !baseValid;
  }

  function renderSolve(sceneEv) {
      solveWarning.textContent = "";
      solveSuggestedShutter = NaN;
      if (!isFinite(sceneEv)) {
          solveResult.textContent = "--";
          solveDesc.textContent = "請先完成基準參數。";
          return;
      }

      const mode = solveParam.value;
      solveDesc.textContent = "固定 ISO / 光圈 / ND 兩項後，系統會告訴你該改哪個參數。";

      const desiredShutter = parseShutter(solveShutter.value);
      const desiredAperture = Number(solveAperture.value);
      const desiredIso = Number(solveIso.value);
      const desiredNd = Number(solveNd.value) || 0;

      const unlockedCandidates = [];
      solveLockButtons.forEach((button) => {
          const targetId = button.dataset.solveLock;
          if (targetId && targetId !== `solve-${mode}`) {
              if (button.dataset.locked === "false") {
                  unlockedCandidates.push(targetId);
              }
          }
      });

      if (unlockedCandidates.length === 0) {
          solveFields.forEach((field) => field.classList.remove("field-highlight"));
          solveResult.textContent = "請解鎖 ISO / 光圈 / ND 任一項。";
          return;
      }
      if (unlockedCandidates.length > 1) {
          solveFields.forEach((field) => field.classList.remove("field-highlight"));
          solveResult.textContent = "請只解鎖一項參數來求解。";
          return;
      }

      const unlocked = unlockedCandidates[0];
      solveFields.forEach((field) => {
          field.classList.toggle("field-highlight", field.dataset.solveField === unlocked);
      });
      const fixedIso = Number(solveIso.value);
      const fixedAperture = Number(solveAperture.value);
      const fixedNd = Number(solveNd.value) || 0;
      const fixedShutter = parseShutter(solveShutter.value);

      if (mode === "shutter") {
          if (unlocked === "solve-nd") {
              const nd = computeNdFromShutter(sceneEv, desiredShutter, fixedAperture, fixedIso);
              if (nd < 0 || nd > 15) {
                  solveWarning.textContent = "警告：ND 檔數超出常見範圍，請確認條件。";
              }
              const nearest = nearestOption(ndOptions, nd);
              setWheelValue(solveNd, nearest, true, false);
              solveResult.textContent = `建議 ND ${formatNdLabel(nd)}`;
              if (countdownMode === "solve") {
                  const nearestShutter = nearestShutterValue(desiredShutter);
                  setWheelValue(solveShutter, nearestShutter, true, false);
              }
              return;
          }
          if (unlocked === "solve-iso") {
              const iso = computeIsoFromShutter(sceneEv, desiredShutter, fixedAperture, fixedNd);
              if (iso < 50 || iso > 102400) {
                  solveWarning.textContent = "警告：ISO 超出常見範圍，請確認條件。";
              }
              const nearest = nearestOption(isoOptions, iso);
              setWheelValue(solveIso, nearest, true, false);
              solveResult.textContent = `建議 ISO ${Math.round(iso)}`;
              if (countdownMode === "solve") {
                  const nearestShutter = nearestShutterValue(desiredShutter);
                  setWheelValue(solveShutter, nearestShutter, true, false);
              }
              return;
          }
          if (unlocked === "solve-aperture") {
              const aperture = computeApertureFromShutter(sceneEv, desiredShutter, fixedIso, fixedNd);
              if (aperture < 0.7 || aperture > 64) {
                  solveWarning.textContent = "警告：光圈超出常見範圍，請確認條件。";
              }
              const nearest = nearestOption(apertureOptions, aperture);
              setWheelValue(solveAperture, nearest, true, false);
              solveResult.textContent = `建議光圈 f/${aperture.toFixed(2)}`;
              if (countdownMode === "solve") {
                  const nearestShutter = nearestShutterValue(desiredShutter);
                  setWheelValue(solveShutter, nearestShutter, true, false);
              }
              return;
          }
      }

      if (mode === "aperture") {
          if (unlocked === "solve-shutter") {
              const shutter = computeTargetShutter(sceneEv, desiredAperture, fixedIso, fixedNd);
              if (shutter < 1 / 8000 || shutter > 1800) {
                  solveWarning.textContent = "警告：快門時間超出常見範圍，請確認條件。";
              }
              const nearest = nearestShutterValue(shutter);
              setWheelValue(solveShutter, nearest, true, false);
              solveSuggestedShutter = shutter;
              solveResult.textContent = `建議快門 ${formatShutter(shutter)}`;
              return;
          }
          if (unlocked === "solve-iso") {
              const iso = computeIsoFromShutter(sceneEv, fixedShutter, desiredAperture, fixedNd);
              if (iso < 50 || iso > 102400) {
                  solveWarning.textContent = "警告：ISO 超出常見範圍，請確認條件。";
              }
              const nearest = nearestOption(isoOptions, iso);
              setWheelValue(solveIso, nearest, true, false);
              solveResult.textContent = `建議 ISO ${Math.round(iso)}`;
              return;
          }
          if (unlocked === "solve-nd") {
              const nd = computeNdFromShutter(sceneEv, fixedShutter, desiredAperture, fixedIso);
              if (nd < 0 || nd > 15) {
                  solveWarning.textContent = "警告：ND 檔數超出常見範圍，請確認條件。";
              }
              const nearest = nearestOption(ndOptions, nd);
              setWheelValue(solveNd, nearest, true, false);
              solveResult.textContent = `建議 ND ${formatNdLabel(nd)}`;
              return;
          }
      }

      if (mode === "iso") {
          if (unlocked === "solve-shutter") {
              const shutter = computeTargetShutter(sceneEv, fixedAperture, desiredIso, fixedNd);
              if (shutter < 1 / 8000 || shutter > 1800) {
                  solveWarning.textContent = "警告：快門時間超出常見範圍，請確認條件。";
              }
              const nearest = nearestShutterValue(shutter);
              setWheelValue(solveShutter, nearest, true, false);
              solveSuggestedShutter = shutter;
              solveResult.textContent = `建議快門 ${formatShutter(shutter)}`;
              return;
          }
          if (unlocked === "solve-aperture") {
              const aperture = computeApertureFromShutter(sceneEv, fixedShutter, desiredIso, fixedNd);
              if (aperture < 0.7 || aperture > 64) {
                  solveWarning.textContent = "警告：光圈超出常見範圍，請確認條件。";
              }
              const nearest = nearestOption(apertureOptions, aperture);
              setWheelValue(solveAperture, nearest, true, false);
              solveResult.textContent = `建議光圈 f/${aperture.toFixed(2)}`;
              return;
          }
          if (unlocked === "solve-nd") {
              const nd = computeNdFromShutter(sceneEv, fixedShutter, fixedAperture, desiredIso);
              if (nd < 0 || nd > 15) {
                  solveWarning.textContent = "警告：ND 檔數超出常見範圍，請確認條件。";
              }
              const nearest = nearestOption(ndOptions, nd);
              setWheelValue(solveNd, nearest, true, false);
              solveResult.textContent = `建議 ND ${formatNdLabel(nd)}`;
              return;
          }
      }

      if (mode === "nd") {
          if (unlocked === "solve-shutter") {
              const shutter = computeTargetShutter(sceneEv, fixedAperture, fixedIso, desiredNd);
              if (shutter < 1 / 8000 || shutter > 1800) {
                  solveWarning.textContent = "警告：快門時間超出常見範圍，請確認條件。";
              }
              const nearest = nearestShutterValue(shutter);
              setWheelValue(solveShutter, nearest, true, false);
              solveSuggestedShutter = shutter;
              solveResult.textContent = `建議快門 ${formatShutter(shutter)}`;
              return;
          }
          if (unlocked === "solve-iso") {
              const iso = computeIsoFromShutter(sceneEv, fixedShutter, fixedAperture, desiredNd);
              if (iso < 50 || iso > 102400) {
                  solveWarning.textContent = "警告：ISO 超出常見範圍，請確認條件。";
              }
              const nearest = nearestOption(isoOptions, iso);
              setWheelValue(solveIso, nearest, true, false);
              solveResult.textContent = `建議 ISO ${Math.round(iso)}`;
              return;
          }
          if (unlocked === "solve-aperture") {
              const aperture = computeApertureFromShutter(sceneEv, fixedShutter, fixedIso, desiredNd);
              if (aperture < 0.7 || aperture > 64) {
                  solveWarning.textContent = "警告：光圈超出常見範圍，請確認條件。";
              }
              const nearest = nearestOption(apertureOptions, aperture);
              setWheelValue(solveAperture, nearest, true, false);
              solveResult.textContent = `建議光圈 f/${aperture.toFixed(2)}`;
          }
      }
  }


    function syncTargetLocked() {
      lockButtons.forEach((button) => {
        const targetId = button.dataset.lock;
        const target = document.getElementById(targetId);
        if (!target) return;
        const locked = button.dataset.locked !== "false";
        target.disabled = locked;
        button.textContent = locked ? "解鎖" : "鎖定";
        syncWheelDisabled(target, locked);
        if (locked) {
          if (targetId === "target-aperture") target.value = baseAperture.value;
          if (targetId === "target-iso") target.value = baseIso.value;
          if (targetId === "target-nd") target.value = baseNd.value;
          setWheelValue(target, target.value, true, false);
        }
      });
      targetFields.forEach((field) => {
        const targetId = field.dataset.targetField;
        const button = document.querySelector(`[data-lock="${targetId}"]`);
        const locked = button ? button.dataset.locked !== "false" : true;
        field.classList.toggle("field-highlight", !locked);
      });
    }


    const inputs = [
      baseAperture, baseShutter, baseIso, baseNd,
      targetAperture, targetIso, targetNd,
      solveParam, solveShutter, solveAperture, solveIso, solveNd
    ];

    inputs.forEach((input) => {
      input.addEventListener("input", () => {
        syncTargetLocked();
        syncSolveLocked();
        if (countdownTimer) stopCountdown("--");
        render();
      });
    });

    solveParam.addEventListener("input", () => {
      syncSolveLocked(true);
      render();
    });

    solveLockButtons.forEach((button) => {
      button.addEventListener("click", () => {
        const isLocked = button.dataset.locked !== "false";
        solveLockButtons.forEach((other) => {
          if (other !== button && other.dataset.solveLock !== `solve-${solveParam.value}`) {
            other.dataset.locked = "true";
          }
        });
        button.dataset.locked = isLocked ? "false" : "true";
        syncSolveLocked();
        render();
      });
    });

    modeToggles.forEach((button) => {
      button.addEventListener("click", () => {
        countdownMode = button.dataset.mode;
        modeToggles.forEach((item) => item.classList.toggle("active", item === button));
        targetSection.classList.toggle("active-mode", countdownMode === "target");
        solveSection.classList.toggle("active-mode", countdownMode === "solve");
        if (countdownTimer) stopCountdown("--");
        render();
      });
    });

    document.addEventListener("click", (event) => {
      const wheel = event.target.closest(".wheel");
      if (!wheel) {
        document.querySelectorAll(".wheel").forEach((item) => item.classList.add("collapsed"));
      }
    });

    lockButtons.forEach((button) => {
      button.addEventListener("click", () => {
        button.dataset.locked = button.dataset.locked === "false" ? "true" : "false";
        syncTargetLocked();
        if (countdownTimer) stopCountdown("--");
        render();
      });
    });

    countdownBtn.addEventListener("click", startCountdown);
    populateOptions();
    syncTargetLocked();
    syncSolveLocked(true);
    targetSection.classList.toggle("active-mode", countdownMode === "target");
    solveSection.classList.toggle("active-mode", countdownMode === "solve");
    modeToggles.forEach((item) => item.classList.toggle("active", item.dataset.mode === countdownMode));
    render();
  </script>
</body>
</html>
